<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gestión de Estudiantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    th, td { vertical-align: middle; }
    .table thead th { white-space: nowrap; }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .modal-content {
      border-radius: 12px;
    }
  </style>
</head>
<body class="py-4">

  <div class="container">
    <!-- Encabezado -->
    <div class="card mb-4 border-0 shadow-sm">
      <div class="card-body d-flex justify-content-between align-items-center bg-primary text-white rounded">
        <h1 class="h4 m-0"><i class="bi bi-people-fill me-2"></i>Gestión de Estudiantes</h1>
        <div>
          <a class="btn btn-outline-light me-2" href="/tipos-sangre">
            <i class="bi bi-droplet me-1"></i> Ver tipos de sangre
          </a>
          <button id="btnNuevo" class="btn btn-light text-primary fw-semibold">
            <i class="bi bi-plus-circle me-1"></i> Nuevo
          </button>
        </div>
      </div>
    </div>

    <% if (error) { %>
      <div class="alert alert-danger shadow-sm"><%= typeof error === 'string' ? error : JSON.stringify(error) %></div>
    <% } %>

    <!-- Tabla -->
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tblEstudiantes">
            <thead class="table-primary text-center">
              <tr>
                <th>Carné</th>
                <th>Nombres</th>
                <th>Apellidos</th>
                <th>Dirección</th>
                <th>Teléfono</th>
                <th>Correo</th>
                <th>Fecha nacimiento</th>
                <th>Tipo sangre</th>
                <th style="width:140px">Acciones</th>
              </tr>
            </thead>
            <tbody class="text-center">
              <% estudiantes.forEach(e => { %>
                <tr data-estudiante='<%- JSON.stringify(e) %>'>
                  <td><%= e.carne %></td>
                  <td><%= e.nombres %></td>
                  <td><%= e.apellidos %></td>
                  <td><%= e.direccion || "" %></td>
                  <td><%= e.telefono || "" %></td>
                  <td><%= e.correo_Electronico || "" %></td>
                  <td>
                    <% if (e.fecha_Nacimiento) { %>
                      <%= new Date(e.fecha_Nacimiento).toISOString().split('T')[0] %>
                    <% } %>
                  </td>
                  <td><%= e.tipoSangre ? e.tipoSangre.sangre : '' %></td>
                  <td>
                    <div class="btn-group" role="group">
                      <button class="btn btn-sm btn-outline-primary btn-edit">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <form action="/estudiantes/<%= e.id_Estudiante %>/delete" method="post" class="frm-delete ms-2">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="mdlEstudiante" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <form id="frmEstudiante" method="post">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="mdlTitle"><i class="bi bi-person-lines-fill me-2"></i>Estudiante</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body bg-light">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Carné</label>
                <input name="carne" id="carne" class="form-control" required
                       pattern="^E(00[1-9]|0[1-9][0-9]|[1-9][0-9]{2})$"
                       title="Formato: E001 a E999">
              </div>
              <div class="col-md-4">
                <label class="form-label">Nombres</label>
                <input name="nombres" id="nombres" class="form-control" required>
              </div>
              <div class="col-md-5">
                <label class="form-label">Apellidos</label>
                <input name="apellidos" id="apellidos" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Dirección</label>
                <input name="direccion" id="direccion" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Teléfono</label>
                <input name="telefono" id="telefono" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Correo electrónico</label>
                <input type="email" name="correo_Electronico" id="correo_Electronico" class="form-control">
              </div>

              <div class="col-md-4">
                <label class="form-label">Fecha de nacimiento</label>
                <input type="date" name="fecha_Nacimiento" id="fecha_Nacimiento" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Tipo de sangre</label>
                <select name="id_Tipo_Sangre" id="id_Tipo_Sangre" class="form-select" required>
                  <% tipos.forEach(t => { %>
                    <option value="<%= t.id_Tipo_Sangre %>"><%= t.sangre %></option>
                  <% }) %>
                </select>
                <input type="hidden" name="tipoSangreNombre" id="tipoSangreNombre">
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
              <i class="bi bi-x-circle me-1"></i>Cancelar
            </button>
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-save2 me-1"></i>Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const mdl = new bootstrap.Modal('#mdlEstudiante');
    const selTipo = document.getElementById('id_Tipo_Sangre');
    const hiddenNombre = document.getElementById('tipoSangreNombre');
    const syncNombre = () => hiddenNombre.value = selTipo.options[selTipo.selectedIndex]?.text || '';
    selTipo.addEventListener('change', syncNombre);
    syncNombre();

    document.getElementById('btnNuevo').addEventListener('click', () => {
      const form = document.getElementById('frmEstudiante');
      form.action = '/estudiantes';
      form.reset();
      syncNombre();
      document.getElementById('mdlTitle').innerText = 'Nuevo estudiante';
      mdl.show();
    });

    document.querySelectorAll('#tblEstudiantes .btn-edit').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        const tr = ev.target.closest('tr');
        const e = JSON.parse(tr.getAttribute('data-estudiante'));
        const form = document.getElementById('frmEstudiante');
        form.action = `/estudiantes/${e.id_Estudiante}`;

        carne.value              = e.carne ?? '';
        nombres.value            = e.nombres ?? '';
        apellidos.value          = e.apellidos ?? '';
        direccion.value          = e.direccion ?? '';
        telefono.value           = e.telefono ?? '';
        correo_Electronico.value = e.correo_Electronico ?? '';
        if (e.fecha_Nacimiento)  fecha_Nacimiento.value = (e.fecha_Nacimiento.split('T')[0]);
        if (e.id_Tipo_Sangre)    selTipo.value = e.id_Tipo_Sangre;
        syncNombre();

        document.getElementById('mdlTitle').innerText = 'Editar estudiante';
        mdl.show();
      });
    });

    document.querySelectorAll('.frm-delete').forEach(f => {
      f.addEventListener('submit', (e) => {
        if (!confirm('¿Seguro que deseas eliminar este registro?')) e.preventDefault();
      });
    });
  </script>
</body>
</html>
